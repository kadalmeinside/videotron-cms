{
    "sourceFile": "app/Http/Controllers/Admin/VideotronActionController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1754161020388,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1754161020388,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Http\\Controllers\\Admin;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Models\\Videotron;\nuse Illuminate\\Http\\RedirectResponse;\nuse Kreait\\Firebase\\Messaging\\CloudMessage;\n\nclass VideotronActionController extends Controller\n{\n    /**\n     * Memicu sinkronisasi paksa pada perangkat tertentu melalui FCM.\n     */\n    public function forceSync(Videotron $videotron): RedirectResponse\n    {\n        // Anda bisa menggunakan policy otorisasi yang sesuai di sini\n        // $this->authorize('manage_videotrons');\n\n        if (empty($videotron->fcm_token)) {\n            return back()->with([\n                'flash' => [\n                    'type' => 'error',\n                    'message' => 'Gagal: Perangkat ini tidak memiliki FCM token terdaftar.',\n                ]\n            ]);\n        }\n\n        try {\n            $messaging = app('firebase.messaging');\n            $message = CloudMessage::withTarget('token', $videotron->fcm_token)\n                ->withData(['action' => 'force_sync']);\n\n            $messaging->send($message);\n\n            \\Log::info(\"Perintah force_sync dikirim secara manual ke perangkat: {$videotron->name}\");\n\n            return back()->with([\n                'flash' => [\n                    'type' => 'success',\n                    'message' => 'Perintah sinkronisasi berhasil dikirim ke ' . $videotron->name,\n                ]\n            ]);\n        } catch (\\Exception $e) {\n            \\Log::error(\"Gagal mengirim FCM manual ke {$videotron->name}: \" . $e->getMessage());\n            return back()->with([\n                'flash' => [\n                    'type' => 'error',\n                    'message' => 'Gagal mengirim perintah. Terjadi kesalahan server.',\n                ]\n            ]);\n        }\n    }\n\n    public function forceUpdate(Videotron $videotron): RedirectResponse\n    {\n        $this->authorize('manage_videotrons');\n\n        if (empty($videotron->fcm_token)) {\n            return back()->with('flash', ['type' => 'error', 'message' => 'Gagal: Perangkat tidak memiliki FCM token.']);\n        }\n\n        // Ambil URL APK terbaru dari file konfigurasi\n        // Anda bisa membuat file config/app_settings.php atau menyimpannya di .env\n        $latestApkUrl = config('app_settings.latest_apk_url');\n        $latestVersionCode = config('app_settings.latest_version_code');\n\n        if (empty($latestApkUrl) || empty($latestVersionCode)) {\n             return back()->with('flash', ['type' => 'error', 'message' => 'Gagal: URL APK atau versi terbaru belum diatur di server.']);\n        }\n        \n        // Opsional: Cek apakah perangkat sudah menggunakan versi terbaru\n        if ($videotron->app_version_code >= $latestVersionCode) {\n            return back()->with('flash', ['type' => 'info', 'message' => 'Info: Perangkat sudah menggunakan versi aplikasi terbaru.']);\n        }\n\n        try {\n            $messaging = app('firebase.messaging');\n            $message = CloudMessage::withTarget('token', $videotron->fcm_token)\n                ->withData([\n                    'action' => 'force_update',\n                    'apk_url' => $latestApkUrl,\n                    'version_code' => (string)$latestVersionCode // Kirim sebagai string\n                ]);\n\n            $messaging->send($message);\n\n            \\Log::info(\"Perintah force_update dikirim ke: {$videotron->name}\");\n\n            return back()->with('flash', ['type' => 'success', 'message' => 'Perintah update berhasil dikirim ke ' . $videotron->name]);\n\n        } catch (\\Exception $e) {\n            \\Log::error(\"Gagal mengirim FCM update ke {$videotron->name}: \" . $e->getMessage());\n            return back()->with('flash', ['type' => 'error', 'message' => 'Gagal mengirim perintah. Terjadi kesalahan server.']);\n        }\n    }\n}\n"
        }
    ]
}