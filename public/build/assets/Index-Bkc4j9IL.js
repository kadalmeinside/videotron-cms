import{r as n,y as q,z,f as i,o as u,h as y,b as l,F as G,i as L,k as K,a as g,u as R,g as Q,n as E,c as X,t as k,d as Y,w as Z,e as M,a8 as ee,a9 as ae,A as U}from"./app-BLeNn4LO.js";import{P as le}from"./plyr-D_3sJyRt.js";import{_ as N}from"./TextInput-DSC7ne63.js";import{_ as te}from"./PrimaryButton-6Sj3evt6.js";import{_ as C}from"./InputLabel-CgxTHTmz.js";import{_ as oe}from"./InputError-Bjz1dp-D.js";const ne=["src"],se=["data-plyr-embed-id"],re={__name:"PlyrPlayer",props:{media:{type:Object,required:!0}},emits:["playing","ended"],setup(d,{emit:m}){const s=m,t=n(null);let r=null;return q(()=>{if(!t.value)return;const v={autoplay:!0,muted:!1,controls:!1,loop:{active:!1},clickToPlay:!1};r=new le(t.value,v),r.on("playing",()=>s("playing")),r.on("ended",()=>s("ended"))}),z(()=>{r&&r.destroy()}),(v,f)=>(u(),i(G,null,[d.media.source_type==="local"?(u(),i("video",{key:0,ref_key:"playerEl",ref:t,playsinline:""},[l("source",{src:d.media.source_value,type:"video/mp4"},null,8,ne)],512)):y("",!0),d.media.source_type==="youtube"?(u(),i("div",{key:1,ref_key:"playerEl",ref:t,"data-plyr-provider":"youtube","data-plyr-embed-id":d.media.source_value},null,8,se)):y("",!0)],64))}},ue={key:0,class:"bg-gray-900 text-white main-grid p-4"},ie={key:1,class:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-lg font-mono py-1 px-3 rounded-md z-10"},de={key:0,class:"bg-red-600 rounded-md shadow-lg p-2 overflow-hidden whitespace-nowrap"},ce={class:"marquee-content font-semibold text-lg"},ve={key:1,class:"fullscreen-overlay flex items-center justify-center text-center p-4"},ge={class:"text-xl text-gray-400 mt-2"},me={class:"mt-6 p-3 bg-black bg-opacity-50 rounded-lg"},pe={class:"text-lg text-yellow-300 font-mono"},ye={key:1,class:"h-screen w-screen bg-gray-800 flex items-center justify-center p-6"},fe={class:"w-full max-w-sm bg-white rounded-lg shadow-md p-8"},Pe={__name:"Index",props:{videotronUuid:String},setup(d){const m=d,s=n("loading"),t=n(null),r=n(null),v=n(null),f=n(0),T=n("Menghubungkan..."),p=n(0),w=n(!1),S=n(""),c=n({password:"",processing:!1}),$=n(null),V=n(null);let x=null,_=null,b=null;const o=L(()=>{var e,a;return w.value&&s.value==="playing"&&((a=(e=t.value)==null?void 0:e.media)==null?void 0:a.length)>0?t.value.media[f.value]:null}),h=L(()=>s.value==="loading"),A=()=>{!t.value||t.value.media.length===0||(clearTimeout(b),f.value=(f.value+1)%t.value.media.length)},O=()=>{if(clearInterval(_),!o.value){p.value=0;return}p.value=o.value.duration,_=setInterval(()=>{p.value>0?p.value--:clearInterval(_)},1e3)},W=()=>{!o.value||!t.value||!r.value||!v.value||U.post("/api/log/play",{media_id:o.value.id,videotron_id:v.value,playlist_id:t.value.id,schedule_id:r.value}).catch(e=>{var a;return console.error("Gagal mengirim play log:",(a=e.response)==null?void 0:a.data)})},P=async()=>{try{const e=await U.get(`/api/player/${m.videotronUuid}/now`);T.value=e.data.server_time;const a=JSON.stringify(e.data.playlist)!==JSON.stringify(t.value);s.value=e.data.status,s.value==="playing"&&a?(t.value=e.data.playlist,r.value=e.data.schedule_id,v.value=e.data.videotron_id,f.value=0):s.value!=="playing"&&(t.value=null,r.value=null,v.value=null)}catch{s.value="error",T.value="Gagal terhubung ke server."}},F=()=>{var e;O(),W(),clearTimeout(b),((e=o.value)==null?void 0:e.duration)>0&&(b=setTimeout(A,o.value.duration*1e3))},J=async()=>{c.value.processing=!0,S.value="";try{const a=(await U.post("/api/player/login",{uuid:m.videotronUuid,password:c.value.password})).data.token;a&&(localStorage.setItem(`videotron_token_${m.videotronUuid}`,a),w.value=!0,B(a),P(),x=setInterval(P,6e4))}catch(e){console.error("Login Gagal:",e),S.value="Password atau ID Videotron salah."}finally{c.value.processing=!1}},B=e=>{window.Pusher=ee,window.Echo=new ae({broadcaster:"reverb",key:"ODWoLpo5gnEEwsPonM4",wsHost:"localhost",wsPort:"8080",wssPort:"8080",forceTLS:!1,enabledTransports:["ws","wss"],authEndpoint:"/broadcasting/auth",auth:{headers:{Authorization:`Bearer ${e}`}}}),window.Echo.join("monitoring").here(a=>{console.log("Player berhasil join. Pengguna lain yang online:",a.map(I=>I.name))}).joining(a=>{console.log("User lain bergabung:",a.name)}).leaving(a=>{console.log("User lain meninggalkan:",a.name)}).error(a=>{console.error("Gagal terhubung ke channel:",a)})};return q(()=>{const e=localStorage.getItem(`videotron_token_${m.videotronUuid}`);e?(console.log("Token ditemukan, mencoba menghubungkan..."),w.value=!0,B(e),P(),x=setInterval(P,6e4)):(console.log("Tidak ada token, menampilkan form login."),s.value="login_required")}),z(()=>{window.Echo&&window.Echo.leave("monitoring"),x&&clearInterval(x),_&&clearInterval(_),b&&clearTimeout(b)}),K(o,e=>{const a="transparent";$.value&&($.value.style.backgroundImage=e!=null&&e.top_banner_url?`url('${e.top_banner_url}')`:a),V.value&&(V.value.style.backgroundImage=e!=null&&e.bottom_banner_url?`url('${e.bottom_banner_url}')`:a)},{immediate:!0,deep:!0}),(e,a)=>{var I,D,j;return u(),i(G,null,[g(R(Q),{title:"Videotron Player"}),w.value?(u(),i("div",ue,[l("div",{ref_key:"topBannerEl",ref:$,class:E(["ads-banner rounded-lg shadow-lg",{"animate-pulse bg-gray-800":h.value&&!((I=o.value)!=null&&I.top_banner_url)}])},null,2),l("div",{class:E(["video-container rounded-lg shadow-lg relative",{"animate-pulse bg-black":h.value}])},[o.value?(u(),X(re,{key:o.value.id,media:o.value,onPlaying:F,onEnded:A},null,8,["media"])):y("",!0),s.value==="playing"&&p.value>0?(u(),i("div",ie," Sisa Waktu: "+k(p.value)+"s ",1)):y("",!0)],2),l("div",{ref_key:"bottomBannerEl",ref:V,class:E(["ads-banner rounded-lg shadow-lg",{"animate-pulse bg-gray-800":h.value&&!((D=o.value)!=null&&D.bottom_banner_url)}])},null,2),(j=o.value)!=null&&j.running_text&&!h.value?(u(),i("div",de,[l("p",ce,k(o.value.running_text),1)])):y("",!0),s.value!=="playing"&&!h.value?(u(),i("div",ve,[l("div",null,[a[1]||(a[1]=l("h1",{class:"text-4xl font-bold"},"TIDAK ADA JADWAL",-1)),l("p",ge,"Videotron ID: "+k(d.videotronUuid),1),l("div",me,[l("p",pe,"Waktu Server: "+k(T.value),1)])])])):y("",!0)])):(u(),i("div",ye,[l("div",fe,[a[2]||(a[2]=l("h2",{class:"text-2xl font-bold text-center text-gray-900"},"Aktivasi Player",-1)),a[3]||(a[3]=l("p",{class:"text-center text-gray-500 mt-2"},"Masukkan password untuk videotron ini.",-1)),l("form",{onSubmit:Y(J,["prevent"]),class:"mt-8 space-y-6"},[l("div",null,[g(C,{for:"uuid",value:"Videotron ID"}),g(N,{id:"uuid",type:"text",class:"mt-1 block w-full bg-gray-100",value:d.videotronUuid,disabled:""},null,8,["value"])]),l("div",null,[g(C,{for:"password",value:"Password"}),g(N,{id:"password",type:"password",class:"mt-1 block w-full",modelValue:c.value.password,"onUpdate:modelValue":a[0]||(a[0]=H=>c.value.password=H),required:"",autofocus:""},null,8,["modelValue"]),g(oe,{message:S.value,class:"mt-2"},null,8,["message"])]),l("div",null,[g(te,{class:E(["w-full justify-center",{"opacity-25":c.value.processing}]),disabled:c.value.processing},{default:Z(()=>[M(k(c.value.processing?"Menghubungkan...":"Aktivasi"),1)]),_:1},8,["class","disabled"])])],32)])]))],64)}}};export{Pe as default};
